---
title: 大型分布式网站架构读书笔记
date: 2016-10-07 22:52:31
tags: 读书笔记
---
## 面向服务的体系架构
> RPC全称是Remote Process Call，即远程过程调用

#### 基于TCP协议的RPC
通过Socket实现

* 服务消费者通过Socket传送要调用的接口名称、方法名称、参数类型和参数对象给服务端
* 服务端接受到接口名称、方法名称和参数再通过反射调用方法并返回数据。
 <!--more-->

#### 基于HTTP协议的RPC
应用层协议也是基于TCP协议实现的，只是又加了一层Response和Request

#### RESTful和RPC
两种都是较为主流的URL链接风格
##### RPC
`http://hostname/proider.do?service=com,http.sayhello&format=json&timestamp=2013-07-07-13-22-09&arg1=arg1&arg2=arg2`
##### RESTful
通过HTTP请求对应的POST、GET、PUT、DELETE方法来完成对应的CRUD操作

`POST http://hostname/people/zhangsan  //创建people记录`

`GET http://hostname/people/zhangsan  //查询people记录`

`PUT http://hostname/people/zhangsan  //修改people记录`

`DELETE http://hostname/people/zhangsan  //删除people记录`

#### 服务的路由
* 规模小的时候，才用硬编码将服务地址和配置写在代码中、或者通过Nginx等软件解决方案
* 服务越来越多、规模越来越大的时候，人工管理难以维护、Nginx等软件容易出现单点故障，需要一个能够动态注册和获取服务信息的地方来统一管理服务名称和其对应的服务列表信息，这就有了服务配置中心
* 但是服务配置中心也有出现宕机的可能，于是就有了ZooKeeper（hadoop下的子项目）这样的框架，它拥有容错特性和leader选举机制，能保障方便的扩容

#### 负载均衡
1. 轮询法（需要使用的悲观锁synchronized，会有性能损失）
2. 随机法（随着调用量的增大，效果接近于平均分配，也就是轮询的效果）
3. 源地址哈希法（可以保证服务消费者总是连接到同一台服务器）
4. 加权轮询法（不同服务器可能有不同的性能，所有有不同的权重）
5. 加权随机法
6. 最小连接数（根据当时服务器的连接情况）

#### HTTP服务网关
为了完成相应的权限和安全校验，在服务消费者和服务端之间架设的措施。

为了防止单点故障，需要网关集群。

---
## 分布式系统基础设施
> 一个大型、文件、成熟的分布式系统的背后，往往会涉及众多的支撑系统，即分布式系统的基础设施。除了前面的分布式协作即配置管理系统ZooKeeper，还需要分布式缓存系统、持久换存储、分布式消息系统、搜索引擎、CDN系统、负载均衡系统、运维自动化系统、实时计算系统、离线计算系统、分布式文件系统、日志收集系统、监控系统、数据仓库等。

#### 分布式缓存
memcache是一款开源的高性能的分布式内存对象缓存系统

#### 持久化存储
##### Mysql
* 业务拆分提高系统稳定性
* Master与Slave的复制架构实现数据同步（也可实现读写分离，一般都是读的多、写的少，所以用于读的Slave可以多设置一点），但是存在单点故障需要使用Master-Master架构
* 分表和分库来提高吞吐能力
*但是关系型数据库不适合处理海量数据，于是便有了Nosql*

##### HBase
高可靠性、高可扩展性、实时读/写的列存储数据库

##### Redis
key-value数据库

#### 消息系统
ActiveMQ

#### 垂直化搜索引擎
Lucene：Apache旗下的一款高性能，可伸缩的开源信息检索库，可以十分容易的为应用程序添加文本搜索功能

Solr：基于Lucene的搜索引擎工具，对Lucene进行了扩展，提供了HTTP操作接口

---
## 互联网安全架构
#### 常见的Web攻击手段
##### XSS攻击
跨站脚本攻击

`<input type="text" name="nick" value="xiaomao">`

如果用户输入的是"/><script>alert("haha")</script><!-

`<input type="text" name="nick" value=""/><script>alert("haha")</script><!-">`

防范：转义特殊字符\&lt; (<)  \&gt; (>)  \&amp; (&)  \&quot; (")
##### CRSF攻击
跨站请求伪造

通过伪装来自受信任用户的请求来利用受信任的网站。

用户成功A网站，之后访问恶意站点B，B要求用户访问A站点（如转账操作），用户带着合法cookie访问A，成功

防范：将cookie设置为HttpOnly、增加token、通过Referer识别（http协议头中）
##### SQL注入攻击
防范：使用预编译语言（JDBC中的？占位符）、使用ORM框架、避免密码的明文存放
##### 文件上传漏洞
防范：限制上传类型（不是通过后缀判断，而是通过魔数来判断）
##### DDos攻击
分布式拒绝服务攻击
* SYN Flood 第二次握手的时候不返回，此时服务端已分配一定资源，服务端多次重试
* DNS Query Flood 伪造假的域名去解析，导致DNS服务器崩溃
* CC攻击 通过http代理进行DDos攻击

#### 常用的安全算法
##### 数字摘要
* MD5
* SHA
##### 对称加密
* DES算法
* AES算法
##### 非对称加密
* RSA算法
##### 数字签名
* MD5withRSA
* SHA1withRSA
##### 数字证书

#### 摘要认证
HTTP协议的请求参数是无序的，所以客户端和服务端需要约定好参数的排序方式（如按字母排序），发送端对参数进行排序，然后加入双方约定好的“盐”，生成摘要
1. 客户端参数摘要生成
2. 服务端参数摘要校验
3. 服务端响应摘要生成
4. 客户端响应摘要校验

#### 签名认证
发送端在生成摘要串后使用私钥对摘要串进行加密，接受端使用公钥进行解密后进行校验

#### HTTPS协议
在HTTP（应用层）和TCP（传输层）之间加入了SLL or TLS（安全层），对HTTP协议传输的参数进行全程加密，和校验服务端和客户端证书的有效性等

#### OAuth协议
用于第三方登录的协议，不需要密码就可取得第三方信息

---
## 系统稳定性
#### 在线日志分析
cat、less、more、tail、sort、wc、find、grep、expr等命令

sed、awk编辑器

#### 集群监控
load值、CPU利用率、磁盘剩余、网络traffic、磁盘I/O、内存使用、qps、rt、select/ps、update/ps、delete/ps、GC

#### 流量控制
* 依赖管理
* 优雅降级
* 服务分级（将服务分出优先级）
* 开关（可以临时关闭某个服务从而降低负载）

#### 性能优化
##### 寻找性能瓶颈
* YSlow（网页性能分析的插件）
* 页面响应时间
* 方法响应时间
* GC日志分析
* 数据库查询（找出最耗时的语句）
* 系统资源使用

##### 性能测试工具
* ab
* Apache JMeter
* HP LoadRunner
* 反向代理引流
* TCPCopy

##### 性能优化措施
###### 前端
* 页面HTTP请求数量
* 是否使用CDN网络
* 是否使用压缩
###### Java
* 单例模式的使用
* Future模式 （如果一个任务需要花费一些时间，为了省去不必要的等待时间，可以先获取一个“提货单”，然后继续处理别的任务，知道货物到达，此时便可用“提货单”进行提货，如果提取的时候货物还没到，程序会陷入阻塞状态）
* 线程池
* 选择就绪 （NIO）
* 减少上下文切换 （CPU切换）
* 降低锁竞争
###### 压缩
* gzip
###### 结果缓存
###### 数据库查询
* 合理使用索引
* 反范式设计
* 使用查询缓存
* 使用搜索引擎
* 使用key-value数据库
###### GC优化
###### 硬件提升性能

#### Java应用故障的排查
* jps
* jstat
* jinfo
* jstack
* jmsp
* BTrace
* JConsole
* Memory Analyzer
* VisualVM

---
## 数据分析
#### 日志收集
1. 通过linux的inotify机制（能够对文件系统的变化进行监控），进行日志的收集
2. 通过消息队列ActiveMQ-CPP进行日志的传输

#### 离线数据分析
Hadoop
##### HDFS
分布式文件系统
##### MapReduce
一种处理海量数据的并行编程模型和计算框架，用于对大规模数据集进行并行计算

#### 流式数据分析
> 流式 数据的特征是数据会源源不断的从各个地方汇集过来，来源众多，格式复杂，且数据流巨大

Storm

开源的分布式实时计算系统，可以简单、可靠的对大量的流失数据进行分析处理。

#### 数据同步
##### 离线数据同步
Sqoop
##### 实时数据同步
可以利用类似ActiveMQ的消息系统来进行实时的增量数控同步

#### 数据报表
Highcharts